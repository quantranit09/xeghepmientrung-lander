document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("leadForm"),n=document.getElementById("formMsg"),t=document.getElementById("callHotline"),o=document.getElementById("callFloating"),i=document.getElementById("heroCall"),a=document.getElementById("date");a&&(a.min=(new Date).toISOString().slice(0,10));const c=window.pushEvent||function(e,n={}){try{window.dataLayer.push({event:e,...n}),"undefined"!=typeof gtag&&gtag("event",e,n)}catch(e){}};document.getElementById("callTop")?.addEventListener("click",(()=>c("call_click",{location:"header_quickbar"}))),document.querySelector('.mobile-quickbar a[href*="facebook.com"]')?.addEventListener("click",(()=>c("facebook_click",{location:"header_quickbar"}))),document.querySelector('.mobile-quickbar a[href="#dat-cho"]')?.addEventListener("click",(()=>c("cta_click",{location:"header_quickbar"}))),t?.addEventListener("click",(()=>c("call_click",{location:"form_button"}))),o?.addEventListener("click",(()=>c("call_click",{location:"floating_cta"}))),i?.addEventListener("click",(()=>c("call_click",{location:"hero_banner"}))),document.querySelectorAll('.price-tag[href*="tel:"]')?.forEach((e=>{e.addEventListener("click",(()=>{const n=e.closest(".card").querySelector("h3")?.textContent||"Unknown Tour";c("call_click",{location:"tour_pricing",tour_name:n.trim()})}))})),e?.addEventListener("submit",(t=>{t.preventDefault();const o=Object.fromEntries(new FormData(e).entries());if(!o.name||!o.phone)return n.textContent="Vui lòng điền họ tên và số điện thoại.",void(n.style.color="#b91c1c");const i=(o.phone||"").replace(/[^+\d]/g,"");c("lead_submit",{name:o.name,phone:i,pickup:o.pickup,dropoff:o.dropoff,date:o.date,time:o.time,seats:o.seats});const a=[];o.pickup&&a.push(`📍 Đón: ${o.pickup}`),o.dropoff&&a.push(`🏁 Trả: ${o.dropoff}`),o.date&&a.push(`📅 Ngày: ${o.date}`),o.time&&a.push(`⏰ Giờ: ${o.time}`),o.seats&&a.push(`👥 Ghế: ${o.seats}`),o.note&&a.push(`💬 Ghi chú: ${o.note}`);const r=`🚌 ĐẶT CHỖ XE GHÉP\n👤 Tên: ${o.name}\n📞 SĐT: ${i}\n${a.join("\n")}\n\nVui lòng xác nhận đặt chỗ. Cảm ơn!`;n.innerHTML="⏳ <strong>Đang gửi yêu cầu...</strong>",n.style.color="#1d4ed8",Promise.allSettled([(async()=>{try{return console.log("Sending to Facebook:",r),!0}catch(e){return console.error("Facebook send failed:",e),!1}})(),(async()=>{try{const e=await fetch("https://xeghepmientrungapi.vercel.app/api/send-email",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:o.name,phone:i,pickup:o.pickup,dropoff:o.dropoff,date:o.date,time:o.time,seats:o.seats,note:o.note,order_info:r})});return(await e.json()).success}catch(e){return console.error("Email send failed:",e),!1}})()]).then((e=>{const t="fulfilled"===e[0].status&&e[0].value,o="fulfilled"===e[1].status&&e[1].value;let i="",a="#166534";t&&o?i='✅ <strong>Yêu cầu đã được gửi thành công!</strong><br>\n        <span style="color: var(--muted); font-size: 14px;">\n          Chúng tôi sẽ liên hệ với bạn trong thời gian sớm nhất. Hoặc bạn có thể:\n        </span>':t||o?i='✅ <strong>Yêu cầu đã được gửi!</strong><br>\n        <span style="color: var(--muted); font-size: 14px;">\n          Chúng tôi sẽ liên hệ với bạn sớm. Hoặc liên hệ trực tiếp:\n        </span>':(i='⚠️ <strong>Có lỗi khi gửi tự động.</strong><br>\n        <span style="color: var(--muted); font-size: 14px;">\n          Vui lòng liên hệ trực tiếp qua:\n        </span>',a="#d97706"),i+='<br><div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">\n        <a href="https://zalo.me/0826430430" target="_blank" rel="noopener" \n           style="display: inline-block; padding: 8px 16px; background: #0068FF; color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">\n          💬 Zalo\n        </a>\n        <a href="tel:+84826430430"\n           style="display: inline-block; padding: 8px 16px; background: var(--primary); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">\n          📞 Gọi ngay\n        </a>\n      </div>',n.innerHTML=i,n.style.color=a})),e.reset()}))}));